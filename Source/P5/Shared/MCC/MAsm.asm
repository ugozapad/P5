	.386
	IDEAL


; Use: TASM Masm.asm -m3 -mx

;-----------------------------------------------------
PUBLIC _GetCPUClock
PUBLIC _FastSqrt32
PUBLIC _FastSqrt64

;-----------------------------------------------------
SEGMENT _DATA DWORD PUBLIC USE32 'DATA'

ENDS _DATA

;-----------------------------------------------------
SEGMENT _CODE DWORD PUBLIC 'CODE' USE32
MODEL FLAT
ASSUME CS:_CODE
ASSUME DS:_DATA

;-----------------------------------------------------
PROC _GetCPUClock C

	dw 0310fh
	ret

; mov [dword ptr t],eax
; mov [dword ptr ret+4],ebx

ENDP

;-----------------------------------------------------
SQRTSIZE = 7;

PROC _FastSqrt32 C

; Ultra-fast sqrt(int32)
; 20 c. on PPro

     push ecx
   	 push edx
     push ebx
     mov ebx,eax
     xor ecx,ecx
     test eax,0ffff0000h
     jz @@L1
     shr ebx,16
     sub cl,16
@@L1:
     test ebx,0ff00h
     jz @@L2
     shr ebx,8
     sub cl,8
@@L2:
	 add cl, [byte ptr ebx + Log2TablePlus24]
     shl eax, cl
     mov ebx, eax
     shr ebx, 32-SQRTSIZE
     shl eax, SQRTSIZE
     shr cl, 1
     mul [dword ptr 4*ebx + dSqrtTable]
     mov eax, [dword ptr 4*ebx + SqrtTable]
	 pop ebx
     add eax, edx
	 pop edx
     shr eax, cl
	 pop ecx
	 ret
ENDP

PROC _FastSqrt64 C

; Ultra-fast sqrt(int64)
; 21 c. on PPro

	int 3
	; FIXME:  FNISS!, funkar inte, måste spara registren!!!

	 mov eax, [esp + 8]	; High
     test eax,0ffffffffh
	 jnz @@L0
	 mov eax, [esp + 4]	; Low
	 jmp _FastSqrt32
@@L0:
	 xor ecx, ecx
	 mov edx, [esp + 4]	; Low
     mov ebx, eax
     test eax, 0ffff0000h
     jz @@L1
     shr ebx, 16
     sub cl, 16
@@L1:
     test ebx, 0ff00h
     jz @@L2
     shr ebx, 8
     sub cl, 8
@@L2:
	 add cl, [byte ptr ebx + Log2TablePlus24]
	 shld eax, edx, cl
     mov ebx, eax
     shr ebx, 32-SQRTSIZE
     shl eax, SQRTSIZE
     shr cl, 1
     mul [dword ptr 4*ebx + dSqrtTable64]
     mov eax, [dword ptr 4*ebx + SqrtTable64]
     add eax, edx
     shr eax, cl
	 ret
ENDP


SqrtTable:
	dd 1,5794,8193,10034,11586,12954,14190,15327,16385,17379,18319,19213,20067,20887,21675,22436
	dd 23171,23885,24577,25250,25906,26546,27171,27781,28379,28964,29538,30100,30653,31195,31728,32253
	dd 32769,33277,33777,34271,34757,35236,35709,36176,36637,37092,37541,37986,38425,38859,39288,39713
	dd 40133,40549,40961,41369,41772,42172,42568,42960,43349,43734,44116,44495,44870,45243,45612,45978
	dd 46342,46703,47060,47416,47768,48118,48466,48810,49153,49493,49831,50167,50500,50831,51160,51487
	dd 51812,52135,52455,52774,53091,53406,53720,54031,54341,54648,54955,55259,55562,55863,56163,56460
	dd 56757,57052,57345,57637,57927,58216,58504,58790,59074,59358,59640,59920,60200,60478,60754,61030
	dd 61304,61577,61849,62120,62389,62658,62925,63191,63456,63720,63983,64244,64505,64764,65023,65280

dSqrtTable:
	dd 5793,2399,1841,1552,1368,1236,1137,1058,994,940,894,854,820,788,761,735
	dd 714,692,673,656,640,625,610,598,585,574,562,553,542,533,525,516
	dd 508,500,494,486,479,473,467,461,455,449,445,439,434,429,425,420
	dd 416,412,408,403,400,396,392,389,385,382,379,375,373,369,366,364
	dd 361,357,356,352,350,348,344,343,340,338,336,333,331,329,327,325
	dd 323,320,319,317,315,314,311,310,307,307,304,303,301,300,297,297
	dd 295,293,292,290,289,288,286,284,284,282,280,280,278,276,276,274
	dd 273,272,271,269,269,267,266,265,264,263,261,261,259,259,257,257

Log2TablePlus24:
	db 24, 30, 30, 30, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28 
	db 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26 
	db 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26 
	db 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26, 26 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24 
	db 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24

SqrtTable64:
	dd 1,379625063,536870913,657529897,759250126,848867447,929887698,1004393508,1073741825,1138875188,1200479855,1259073894,1315059793,1368757629,1420426920,1470281546
	dd 1518500251,1565234232,1610612737,1654747285,1697734892,1739660586,1780599377,1820617843,1859775394,1898125313,1935715603,1972589689,2008787015,2044343527,2079292102,2113662895
	dd 2147483649,2180779955,2213575478,2245892158,2277750376,2309169107,2340166052,2370757756,2400959710,2430786440,2460251594,2489368011,2518147788,2546602338,2574742445,2602578307
	dd 2630119585,2657375438,2684354561,2711065215,2737515258,2763712173,2789663091,2815374815,2840853840,2866106370,2891138342,2915955436,2940563091,2964966522,2989170732,3013180521
	dd 3037000501,3060635103,3084088588,3107365059,3130468463,3153402604,3176171150,3198777635,3221225473,3243517957,3265658268,3287649481,3309494569,3331196405,3352757772,3374181362
	dd 3395469784,3416625563,3437651150,3458548918,3479321170,3499970142,3520498002,3540906857,3561198753,3581375678,3601439564,3621392291,3641235685,3660971524,3680601539,3700127413
	dd 3719550788,3738873260,3758096385,3777221681,3796250626,3815184662,3834025194,3852773596,3871431204,3889999326,3908479237,3926872182,3945179377,3963402012,3981541246,3999598215
	dd 4017574028,4035469770,4053286500,4071025256,4088687054,4106272886,4123783724,4141220519,4158584203,4175875688,4193095867,4210245615,4227325789,4244337230,4261280759,4278157184

dSqrtTable64:
	dd 379625062,157245850,120658984,101720229,89617321,81020251,74505810,69348317,65133363,61604667,58594039,55985899,53697836,51669291,49854626,48218705
	dd 46733981,45378505,44134548,42987608,41925693,40938791,40018466,39157552,38349919,37590289,36874087,36197325,35556513,34948575,34370793,33820754
	dd 33296306,32795524,32316680,31858218,31418731,30996945,30591704,30201953,29826730,29465154,29116417,28779777,28454550,28140107,27835862,27541278
	dd 27255853,26979123,26710654,26450043,26196915,25950918,25711724,25479024,25252531,25031972,24817093,24607655,24403432,24204210,24009789,23819980
	dd 23634602,23453486,23276470,23103404,22934141,22768546,22606486,22447838,22292484,22140311,21991213,21845087,21701836,21561367,21423590,21288422
	dd 21155780,21025587,20897768,20772252,20648972,20527860,20408855,20291896,20176925,20063886,19952726,19843394,19735839,19630015,19525875,19423374
	dd 19322472,19223125,19125296,19028945,18934036,18840533,18748401,18657608,18568122,18479911,18392945,18307196,18222635,18139234,18056969,17975813
	dd 17895741,17816730,17738757,17661798,17585832,17510838,17436795,17363684,17291485,17220179,17149748,17080174,17011440,16943529,16876425,16810113

;-----------------------------------------------------
ENDS _CODE

END
